# PB-003: Malware Infection Response Playbook

## Playbook Metadata

- **Playbook ID:** PB-003
- **Title:** Malware Infection Response
- **Version:** 1.0
- **Severity:** High to Critical (depending on malware type and scope)
- **Owner:** SOC Tier 1 Team
- **Last Updated:** 2026-02-10
- **Review Cycle:** Quarterly
- **MITRE ATT&CK:** Execution - User Execution (T1204), Command and Scripting Interpreter (T1059), Persistence - Scheduled Task/Job (T1053), Command and Control - Application Layer Protocol (T1071)

## Purpose

This playbook provides standardized procedures for responding to malware infections. It guides SOC analysts through detection, triage, containment, eradication, and recovery to minimize impact and prevent malware spread across the environment.

## Trigger Conditions

This playbook should be initiated when:

- **EDR Alert:** Endpoint detection and response system flags malicious process or behavior
- **Antivirus Detection:** AV/anti-malware solution quarantines suspicious file
- **SIEM Alert:** Correlation rule triggers on process anomaly, unusual network connection, or suspicious file creation
- **User Report:** User reports unusual system behavior (slowness, popups, ransom notes)
- **Network Alert:** C2 beaconing detected, suspicious outbound connections to known malicious IPs/domains
- **Threat Intelligence:** Known IOCs (hash, domain, IP) detected in environment
- **IDS/IPS Alert:** Malware signature or exploit attempt detected

## Scope

**In Scope:**
- Traditional malware (trojans, worms, viruses, rootkits)
- Ransomware infections
- Banking trojans and info stealers
- RATs (Remote Access Trojans)
- Cryptominers
- Droppers and loaders
- Fileless malware
- Living-off-the-land (LOLBin) abuse

**Out of Scope:**
- Pure phishing emails (no execution) - Use phishing playbook
- Web-only attacks with no endpoint component - Use web attack playbook
- DDoS attacks - Use DDoS playbook
- Insider threats with legitimate tools - Escalate to insider threat team

## Severity Classification

| Severity | Criteria |
|----------|----------|
| **Critical** | Ransomware encryption in progress, widespread infection (>10 hosts), privileged account compromise, domain controller infected, data exfiltration confirmed, wiper malware |
| **High** | Active C2 communication, credential theft malware, lateral movement detected, server infection, persistent malware on critical system |
| **Medium** | Single endpoint infection, no C2 communication, contained by EDR, common commodity malware, no privilege escalation |
| **Low** | False positive confirmed, already quarantined by AV, non-executable file, test/PoC malware |

## Investigation Steps

### Step 1: Initial Triage (5 minutes)

**Objective:** Confirm malware presence and identify affected system.

**Actions:**
1. Review the triggering alert details:
   - **Alert Source:** EDR, AV, SIEM, IDS, user report?
   - **Hostname/IP:** Which system is affected?
   - **Username:** Which user account is involved?
   - **Detection Name:** What did security tool identify?
   - **File Path:** Where is malicious file located?
   - **Process Name:** What process triggered alert?
   - **Time of Detection:** When was malware detected?

2. Document initial observations:
   - Is system currently online?
   - Is malware actively running?
   - Are there multiple affected systems?
   - Is this a known malware family?

**Splunk Query - Process Creation Alert:**
```spl
index=windows_sysmon EventCode=1 earliest=-1h
| search CommandLine="*powershell*" OR CommandLine="*cmd.exe*" OR Image="*\\Temp\\*" OR Image="*\\AppData\\*"
| table _time, ComputerName, User, Image, CommandLine, ParentImage, ParentCommandLine
| sort -_time
```

**Splunk Query - EDR Alerts:**
```spl
index=edr (action="blocked" OR action="quarantined" OR severity="high") earliest=-1h
| stats count by host, user, threat_name, file_path, action
| sort -count
```

### Step 2: Identify Affected Host Details (5 minutes)

**Objective:** Gather comprehensive information about infected system.

**Actions:**

1. **System Information:**
   - Hostname: [DESKTOP-ABC123]
   - IP Address: [10.x.x.x]
   - MAC Address: [00:11:22:33:44:55]
   - Operating System: [Windows 10/Server 2019/Linux]
   - Domain/Workgroup: [CORP/WORKGROUP]
   - System Owner: [John Doe / Department]
   - System Role: [Workstation/Server/Critical Asset]
   - Last Boot Time: [Check uptime]

2. **User Information:**
   - Username: [jdoe]
   - User Role: [Standard/Admin/Service Account]
   - User Location: [Department/Building]
   - User Contact: [email/phone]

3. **Network Information:**
   - VLAN: [Production/Guest/Management]
   - Network Segment: [Corporate/DMZ/Server]
   - Network Neighbors: [Check ARP table]

**Splunk Query - Host Activity Summary:**
```spl
index=windows_sysmon ComputerName="DESKTOP-ABC123" earliest=-24h
| stats count by EventCode, User, Image
| sort -count
```

**Splunk Query - User Session Information:**
```spl
index=windows_security EventCode=4624 ComputerName="DESKTOP-ABC123" earliest=-24h
| table _time, Account_Name, Logon_Type, src_ip, Workstation_Name
| sort -_time
```

### Step 3: Malware Artifact Analysis (10 minutes)

**Objective:** Identify malware file, hash, and initial behavior.

**Actions:**

1. **File Information:**
   - **File Name:** [suspicious.exe]
   - **File Path:** [C:\Users\jdoe\AppData\Local\Temp\suspicious.exe]
   - **File Size:** [2.5 MB]
   - **Creation Time:** [YYYY-MM-DD HH:MM:SS]
   - **Modification Time:** [YYYY-MM-DD HH:MM:SS]

2. **Calculate File Hashes (if possible):**
   ```powershell
   # Windows PowerShell - Local or remote via PSRemoting
   Get-FileHash -Path "C:\Users\jdoe\AppData\Local\Temp\suspicious.exe" -Algorithm MD5
   Get-FileHash -Path "C:\Users\jdoe\AppData\Local\Temp\suspicious.exe" -Algorithm SHA256
   
   # Linux
   md5sum /tmp/suspicious.sh
   sha256sum /tmp/suspicious.sh
   ```

3. **VirusTotal Hash Lookup:**
   - URL: https://www.virustotal.com/
   - Search by SHA256 hash (preferred method - doesn't upload file)
   - Check detection ratio (X/70+ vendors)
   - Review malware family names
   - Check community comments
   - Review behavior sandbox results
   - **Verdict Criteria:**
     - 10+ detections = Confirmed malicious
     - 5-9 detections = Likely malicious
     - 1-4 detections = Suspicious, needs analysis
     - 0 detections = Unknown (new/custom malware)

4. **Process Information:**
   - **Process Name:** [suspicious.exe]
   - **Process ID (PID):** [1234]
   - **Parent Process:** [explorer.exe / outlook.exe / chrome.exe]
   - **Parent PID:** [5678]
   - **Command Line:** [Full command line with arguments]
   - **User Context:** [jdoe / SYSTEM / Administrator]

**Splunk Query - File Creation Events (Sysmon Event 11):**
```spl
index=windows_sysmon EventCode=11 
| search (TargetFilename="*\\Temp\\*.exe" OR TargetFilename="*\\AppData\\*.exe" OR TargetFilename="*.dll" OR TargetFilename="*.bat" OR TargetFilename="*.ps1")
| table _time, ComputerName, User, Image, TargetFilename
| sort -_time
```

**Splunk Query - Process Creation with Hash (Sysmon Event 1):**
```spl
index=windows_sysmon EventCode=1 
| search Hashes="*SHA256=<malware_hash>*" OR Image="*suspicious.exe*"
| table _time, ComputerName, User, Image, CommandLine, ParentImage, Hashes
| sort -_time
```

### Step 4: Process Tree Analysis (10 minutes)

**Objective:** Understand malware execution chain and parent-child relationships.

**Actions:**

1. **Identify Process Hierarchy:**
   - What spawned the malicious process? (email attachment, browser download, script)
   - What did the malicious process spawn? (cmd.exe, powershell.exe, other malware)
   - Are there suspicious child processes?

2. **Common Suspicious Patterns:**
   - Office apps spawning cmd/powershell: `WINWORD.EXE → cmd.exe → powershell.exe`
   - Browser spawning executables: `chrome.exe → suspicious.exe`
   - Script interpreters with encoded commands: `powershell.exe -encodedcommand`
   - Living-off-the-land: `rundll32.exe`, `regsvr32.exe`, `mshta.exe`

3. **Process Tree Red Flags:**
   - Uncommon parent-child relationships
   - Processes running from Temp or AppData folders
   - Unusual command-line arguments (encoded, obfuscated)
   - System processes running from wrong locations
   - Processes with misspelled names (svchost vs svhost)

**Splunk Query - Process Tree Analysis:**
```spl
index=windows_sysmon EventCode=1 ComputerName="DESKTOP-ABC123" earliest=-1h
| eval ParentProcessGuid=coalesce(ParentProcessGuid, "null")
| eval ProcessGuid=coalesce(ProcessGuid, "null")
| table _time, ProcessGuid, ParentProcessGuid, Image, CommandLine, ParentImage, User
| sort _time
```

**Splunk Query - Suspicious Parent-Child Relationships:**
```spl
index=windows_sysmon EventCode=1 earliest=-24h
| search (ParentImage="*WINWORD.EXE" OR ParentImage="*EXCEL.EXE" OR ParentImage="*POWERPNT.EXE" OR ParentImage="*OUTLOOK.EXE")
| search (Image="*cmd.exe" OR Image="*powershell.exe" OR Image="*wscript.exe" OR Image="*cscript.exe")
| table _time, ComputerName, User, ParentImage, Image, CommandLine
| sort -_time
```

**Splunk Query - Encoded PowerShell Commands:**
```spl
index=windows_sysmon EventCode=1 Image="*powershell.exe"
| search CommandLine="*-enc*" OR CommandLine="*-encodedcommand*" OR CommandLine="*-e *" OR CommandLine="*bypass*"
| table _time, ComputerName, User, CommandLine, ParentImage
| sort -_time
```

### Step 5: Network Connection Analysis (10 minutes)

**Objective:** Identify C2 communication and data exfiltration attempts.

**Actions:**

1. **Check Network Connections:**
   - What external IPs/domains did malware contact?
   - What ports were used? (HTTP/HTTPS, custom ports)
   - Was connection successful?
   - How much data was transferred?

2. **C2 Communication Indicators:**
   - Regular beaconing (periodic connections)
   - Connections to suspicious TLDs (.tk, .ml, .cf, .ga)
   - Connections to recently registered domains
   - Use of non-standard ports for common protocols
   - Large data uploads
   - Encrypted traffic to unknown destinations

3. **IP/Domain Reputation Check:**
   - VirusTotal: Check IP/domain reputation
   - AbuseIPDB: Check for malicious reports
   - Threat Intel Feeds: Check against known C2 servers
   - WHOIS: Check domain registration date and registrar

**Splunk Query - Network Connections (Sysmon Event 3):**
```spl
index=windows_sysmon EventCode=3 ComputerName="DESKTOP-ABC123" earliest=-1h
| search NOT (DestinationIp="10.*" OR DestinationIp="172.16.*" OR DestinationIp="192.168.*")
| table _time, Image, DestinationIp, DestinationPort, DestinationHostname, User
| sort -_time
```

**Splunk Query - Connections by Suspicious Processes:**
```spl
index=windows_sysmon EventCode=3 earliest=-1h
| search (Image="*\\Temp\\*" OR Image="*\\AppData\\*") 
| search NOT DestinationIp IN (10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16)
| stats count by Image, DestinationIp, DestinationPort, DestinationHostname
| sort -count
```

**Splunk Query - High Volume Data Transfers:**
```spl
index=firewall_logs earliest=-1h
| search src_ip="10.x.x.x"
| stats sum(bytes_out) as total_bytes by dest_ip, dest_port
| where total_bytes > 10485760
| eval total_mb=round(total_bytes/1048576, 2)
| table dest_ip, dest_port, total_mb
| sort -total_mb
```

**Splunk Query - DNS Queries for Suspicious Domains:**
```spl
index=dns_logs ComputerName="DESKTOP-ABC123" earliest=-1h
| search NOT (query="*.company.com" OR query="*.microsoft.com" OR query="*.google.com")
| table _time, query, answer, query_type
| sort -_time
```

### Step 6: Persistence Mechanism Check (10 minutes)

**Objective:** Identify if malware established persistence on system.

**⚠️ CRITICAL: Malware with persistence will survive reboots and continue infection.**

**Actions:**

1. **Common Persistence Locations:**

   **Windows Registry Run Keys:**
   - `HKCU\Software\Microsoft\Windows\CurrentVersion\Run`
   - `HKLM\Software\Microsoft\Windows\CurrentVersion\Run`
   - `HKCU\Software\Microsoft\Windows\CurrentVersion\RunOnce`
   - `HKLM\Software\Microsoft\Windows\CurrentVersion\RunOnce`

   **Scheduled Tasks:**
   - Look for suspicious task names
   - Check task actions (what executable runs?)
   - Review task triggers (frequency)

   **Windows Services:**
   - Suspicious service names
   - Services pointing to unusual executables
   - Services with random names

   **WMI Event Subscriptions:**
   - Fileless persistence mechanism
   - Check for suspicious event filters

   **Startup Folders:**
   - `C:\Users\<user>\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup`
   - `C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup`

2. **Linux Persistence Locations:**
   - Cron jobs: `/etc/crontab`, `/var/spool/cron/crontabs/`
   - Init scripts: `/etc/init.d/`, `/etc/systemd/system/`
   - User profiles: `~/.bashrc`, `~/.bash_profile`
   - SSH keys: `~/.ssh/authorized_keys`

**Splunk Query - Registry Modifications (Sysmon Event 13):**
```spl
index=windows_sysmon EventCode=13 earliest=-24h
| search (TargetObject="*\\CurrentVersion\\Run*" OR TargetObject="*\\CurrentVersion\\RunOnce*")
| table _time, ComputerName, User, Image, TargetObject, Details
| sort -_time
```

**Splunk Query - Scheduled Task Creation (Sysmon Event 1 + Windows 4698):**
```spl
(index=windows_security EventCode=4698) OR (index=windows_sysmon EventCode=1 Image="*schtasks.exe")
| table _time, ComputerName, User, TaskName, Image, CommandLine
| sort -_time
```

**Splunk Query - Service Installation (Windows Event 7045):**
```spl
index=windows_security EventCode=7045 earliest=-24h
| table _time, ComputerName, Service_Name, Service_File_Name, Service_Type, Service_Start_Type, Account_Name
| sort -_time
```

**Splunk Query - WMI Event Consumer Creation:**
```spl
index=windows_sysmon EventCode=20 OR EventCode=21 earliest=-24h
| table _time, ComputerName, User, EventType, Operation, Consumer, Destination
| sort -_time
```

**Splunk Query - Startup Folder File Creation:**
```spl
index=windows_sysmon EventCode=11 
| search TargetFilename="*\\Start Menu\\Programs\\Startup\\*"
| table _time, ComputerName, User, Image, TargetFilename
| sort -_time
```

### Step 7: Credential Access Check (10 minutes)

**Objective:** Determine if malware attempted credential theft.

**Actions:**

1. **LSASS Access Detection:**
   - Check for process access to LSASS (credential dumping)
   - Look for tools like Mimikatz, ProcDump
   - Detect LSASS memory dumps

2. **Credential Dumping Indicators:**
   - Access to `C:\Windows\System32\config\SAM`
   - Access to `C:\Windows\NTDS\ntds.dit` (on Domain Controllers)
   - PowerShell credential modules loaded
   - Registry credential access

**Splunk Query - LSASS Access (Sysmon Event 10):**
```spl
index=windows_sysmon EventCode=10 TargetImage="*lsass.exe" earliest=-24h
| table _time, ComputerName, User, SourceImage, SourceProcessId, GrantedAccess, CallTrace
| sort -_time
```

**Splunk Query - SAM/NTDS Access:**
```spl
index=windows_sysmon EventCode=11 
| search (TargetFilename="*\\config\\SAM" OR TargetFilename="*\\NTDS\\ntds.dit" OR TargetFilename="*lsass*.dmp")
| table _time, ComputerName, User, Image, TargetFilename
| sort -_time
```

**Splunk Query - Mimikatz Detection:**
```spl
index=windows_sysmon (EventCode=1 OR EventCode=7)
| search (CommandLine="*sekurlsa*" OR CommandLine="*logonpasswords*" OR Image="*mimikatz*" OR Description="*mimikatz*")
| table _time, ComputerName, User, Image, CommandLine, ParentImage
| sort -_time
```

### Step 8: Lateral Movement Check (10 minutes)

**Objective:** Determine if malware spread to other systems.

**Actions:**

1. **Check for Lateral Movement Indicators:**
   - Remote service creation
   - Remote scheduled tasks
   - Remote WMI execution
   - PsExec or similar tool usage
   - SMB connections to multiple hosts
   - RDP connections to multiple hosts

2. **Network Share Access:**
   - Check for malware copying itself to network shares
   - Look for admin share (C$, ADMIN$) access

**Splunk Query - Remote Service Creation:**
```spl
index=windows_security EventCode=7045 
| search Service_File_Name="*\\\\*" OR Service_File_Name="*$*"
| table _time, ComputerName, Service_Name, Service_File_Name, Account_Name
| sort -_time
```

**Splunk Query - PsExec-like Execution:**
```spl
index=windows_sysmon EventCode=1
| search (Image="*psexec*" OR Image="*paexec*" OR Image="*PSEXESVC.exe")
| table _time, ComputerName, User, Image, CommandLine, ParentImage
| sort -_time
```

**Splunk Query - SMB Network Share Access:**
```spl
index=windows_security EventCode=5140 earliest=-1h
| search Share_Name!="IPC$"
| stats count by src_ip, Account_Name, Share_Name, ComputerName
| where count > 10
| sort -count
```

**Splunk Query - Multiple Successful Remote Logins:**
```spl
index=windows_security EventCode=4624 Logon_Type=3 earliest=-1h
| stats dc(ComputerName) as unique_hosts, count by Account_Name, src_ip
| where unique_hosts > 5
| sort -unique_hosts
```

## Containment Actions

### Immediate Containment (Perform within minutes)

**⚠️ CRITICAL: Time is essential. Contain first, investigate deeper later.**

1. **Isolate Infected Endpoint (Highest Priority):**

   **EDR Network Isolation:**
   ```bash
   # CrowdStrike - Network contain host
   falcon-cli contain <hostname>
   
   # Carbon Black - Isolate endpoint
   cb-cli isolate --sensor-id <sensor_id>
   
   # Microsoft Defender ATP - Isolate machine
   Invoke-MDATPMachineIsolation -MachineId <machine_id>
   ```

   **Manual Network Isolation (if EDR unavailable):**
   - Disable network adapter on endpoint
   - Unplug ethernet cable
   - Block MAC address at switch
   - Create firewall rule to block all traffic from/to IP

   **Network Firewall Rule:**
   ```bash
   # Palo Alto - Block host
   set address <hostname> ip-netmask 10.x.x.x/32
   set security-policy deny-malware-host from any to any source <hostname> action deny
   
   # Cisco ASA - Block IP
   access-list DENY_MALWARE deny ip host 10.x.x.x any
   ```

2. **Kill Malicious Process:**

   **Windows (if remote access available):**
   ```powershell
   # Stop process by PID
   Stop-Process -Id 1234 -Force
   
   # Stop process by name
   Stop-Process -Name "suspicious.exe" -Force
   
   # Via EDR
   # CrowdStrike RTR: kill <PID>
   # Carbon Black: kill process via console
   ```

   **Linux:**
   ```bash
   # Kill by PID
   kill -9 1234
   
   # Kill by name
   pkill -9 suspicious
   
   # Find and kill
   ps aux | grep suspicious | awk '{print $2}' | xargs kill -9
   ```

3. **Block C2 Communication:**

   **Firewall - Block Malicious IPs/Domains:**
   ```bash
   # Block at perimeter firewall
   # Add C2 IP to blocklist: 185[.]220[.]45[.]12
   
   # DNS Sinkhole - Redirect malicious domains
   # Add malicious[.]c2[.]com to sinkhole/blackhole
   ```

   **Splunk - Create Watchlist:**
   ```spl
   | inputlookup malware_iocs.csv
   | append [| makeresults | eval ioc="185[.]220[.]45[.]12", ioc_type="ip", threat_name="MalwareX C2", date_added="2026-02-10"]
   | append [| makeresults | eval ioc="malicious[.]c2[.]com", ioc_type="domain", threat_name="MalwareX C2", date_added="2026-02-10"]
   | outputlookup malware_iocs.csv
   ```

   **Proxy Block:**
   ```spl
   index=proxy_logs url="*malicious.c2.com*" OR dest_ip="185.220.45.12"
   | table _time, user, src_ip, url, action
   ```

4. **Block File Hash (EDR/AV):**
   ```powershell
   # Microsoft Defender - Add hash to indicator list
   Add-MpPreference -AttackSurfaceReductionOnlyExclusions "SHA256:abc123..."
   
   # CrowdStrike - Add IOC
   # Via Falcon console: IOC Management → Add SHA256 hash → Action: Detect & Prevent
   
   # Carbon Black - Ban hash
   # Via console: Indicators → Add SHA256 → Action: Ban
   ```

5. **Disable Compromised User Account (if credentials stolen):**
   ```powershell
   # Active Directory - Disable account
   Disable-ADAccount -Identity jdoe
   
   # Force logout all sessions
   Invoke-Command -ComputerName DC01 -ScriptBlock { logoff /server:DESKTOP-ABC123 /v }
   
   # Reset password
   Set-ADAccountPassword -Identity jdoe -Reset -NewPassword (ConvertTo-SecureString "TempP@ssw0rd123!" -AsPlainText -Force)
   ```

### Secondary Containment

6. **Check for Other Infected Systems:**
   ```spl
   # Search for same file hash across environment
   index=windows_sysmon EventCode=1 Hashes="*SHA256=<malware_hash>*" earliest=-7d
   | stats count by ComputerName, User, Image
   | sort -count
   
   # Search for same C2 connections
   index=windows_sysmon EventCode=3 DestinationIp="185.220.45.12" earliest=-7d
   | stats count by ComputerName, Image
   | sort -count
   ```

7. **Isolate Additional Infected Hosts:**
   - Repeat isolation steps for each confirmed infection
   - Prioritize by severity: servers > workstations

8. **Network Segmentation:**
   - If multiple systems in same subnet infected, consider segment isolation
   - Prevent east-west traffic between compromised segment and critical assets

## Eradication

### Step 1: Remove Malware (30-60 minutes)

**Objective:** Completely remove malware and all persistence mechanisms.

**Actions:**

1. **Remove Malicious Files:**
   ```powershell
   # Windows - Delete malware file
   Remove-Item -Path "C:\Users\jdoe\AppData\Local\Temp\suspicious.exe" -Force
   
   # Verify deletion
   Test-Path "C:\Users\jdoe\AppData\Local\Temp\suspicious.exe"
   
   # Linux - Remove malware
   rm -f /tmp/suspicious.sh
   ```

2. **Remove Registry Persistence:**
   ```powershell
   # Remove Run key entries
   Remove-ItemProperty -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Run" -Name "Malware" -Force
   Remove-ItemProperty -Path "HKLM:\Software\Microsoft\Windows\CurrentVersion\Run" -Name "Malware" -Force
   
   # Verify removal
   Get-ItemProperty -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Run"
   ```

3. **Remove Scheduled Tasks:**
   ```powershell
   # List scheduled tasks
   Get-ScheduledTask | Where-Object {$_.TaskName -like "*suspicious*"}
   
   # Remove malicious task
   Unregister-ScheduledTask -TaskName "MaliciousTask" -Confirm:$false
   
   # Linux - Remove cron jobs
   crontab -l | grep -v suspicious | crontab -
   ```

4. **Remove Malicious Services:**
   ```powershell
   # Stop and remove service
   Stop-Service -Name "MaliciousService" -Force
   sc.exe delete MaliciousService
   
   # Linux - Remove systemd service
   systemctl stop malicious.service
   systemctl disable malicious.service
   rm /etc/systemd/system/malicious.service
   ```

5. **Remove WMI Persistence:**
   ```powershell
   # List WMI event consumers
   Get-WMIObject -Namespace root\Subscription -Class __EventConsumer
   
   # Remove malicious consumer
   Get-WMIObject -Namespace root\Subscription -Class __EventConsumer -Filter "Name='MaliciousConsumer'" | Remove-WmiObject
   ```

6. **Remove Startup Folder Items:**
   ```powershell
   # Remove from startup folder
   Remove-Item -Path "C:\Users\jdoe\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup\malware.lnk" -Force
   Remove-Item -Path "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup\malware.lnk" -Force
   ```

7. **Run Full Antivirus Scan:**
   ```powershell
   # Microsoft Defender - Full scan
   Start-MpScan -ScanType FullScan
   
   # Get scan results
   Get-MpThreatDetection
   
   # Remove detected threats
   Remove-MpThreat
   
   # Update definitions first
   Update-MpSignature
   ```

8. **EDR Deep Scan:**
   - Initiate full system scan via EDR console
   - Review all flagged items
   - Remediate as needed

### Step 2: Verify Eradication (15 minutes)

**Objective:** Confirm malware completely removed.

**Actions:**

1. **Verify File Removal:**
   ```powershell
   # Search for malware files
   Get-ChildItem -Path C:\ -Recurse -Filter "suspicious.exe" -ErrorAction SilentlyContinue
   
   # Search by hash (if AV tool supports)
   # Check that hash no longer present on system
   ```

2. **Verify No Active Processes:**
   ```powershell
   # Check for malicious process names
   Get-Process | Where-Object {$_.Name -like "*suspicious*"}
   
   # Check network connections
   Get-NetTCPConnection | Where-Object {$_.RemoteAddress -eq "185.220.45.12"}
   ```

3. **Verify Persistence Removed:**
   ```powershell
   # Check all registry run keys
   Get-ItemProperty -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Run"
   Get-ItemProperty -Path "HKLM:\Software\Microsoft\Windows\CurrentVersion\Run"
   
   # Check scheduled tasks
   Get-ScheduledTask | Where-Object {$_.State -ne "Disabled"} | Select TaskName, TaskPath, State
   
   # Check services
   Get-Service | Where-Object {$_.Status -eq "Running"} | Select Name, DisplayName, StartType
   ```

4. **Check for Reinfection:**
   - Wait 15-30 minutes
   - Monitor for malware reappearance
   - Check if C2 connections resume

5. **Scan with Secondary AV (optional):**
   - Use secondary opinion scanner (Malwarebytes, HitmanPro)
   - Verify clean bill of health

## Recovery

### Step 1: System Restoration (Time varies)

**Objective:** Return system to secure operational state.

**Decision Point: Reimage vs. Clean?**

**Reimage Recommended If:**
- Ransomware infection
- Rootkit detected
- Multiple persistence mechanisms
- Critical system or server
- Clean removal cannot be verified
- Advanced malware (APT, custom)

**Clean/Remediate Acceptable If:**
- Simple commodity malware
- No persistence detected
- EDR confirmed complete removal
- Non-critical workstation
- Business impact of reimage too high

### Reimage Process:

1. **Backup User Data (if safe):**
   ```powershell
   # Backup non-executable user files only
   # NEVER backup .exe, .dll, .bat, .ps1, .vbs, etc.
   robocopy "C:\Users\jdoe\Documents" "\\backup\jdoe\Documents" /XF *.exe *.dll *.bat *.ps1
   ```

2. **Reimage from Known-Good Source:**
   - Use standard SOE (Standard Operating Environment) image
   - Deploy via SCCM, MDT, or imaging tool
   - Ensure image is from before infection

3. **Apply All Patches:**
   ```powershell
   # Windows Update
   Install-Module PSWindowsUpdate
   Get-WindowsUpdate
   Install-WindowsUpdate -AcceptAll -AutoReboot
   ```

4. **Reinstall Applications:**
   - Use enterprise software deployment tool
   - Verify all business-critical apps functional

### Clean/Restore Process:

1. **Restore from Clean Backup (if available):**
   - Restore system state from backup taken before infection
   - Verify backup date predates malware detection

2. **System Integrity Check:**
   ```powershell
   # Windows - System File Checker
   sfc /scannow
   
   # Windows - DISM repair
   DISM /Online /Cleanup-Image /RestoreHealth
   ```

3. **Update All Software:**
   - Patch operating system
   - Update all applications
   - Update EDR/AV definitions

### Step 2: Credential Reset (15 minutes)

**⚠️ CRITICAL: Assume all credentials on infected system are compromised.**

**Actions:**

1. **Force Password Reset for Affected User:**
   ```powershell
   # Active Directory
   Set-ADAccountPassword -Identity jdoe -Reset -NewPassword (ConvertTo-SecureString "NewP@ssw0rd456!" -AsPlainText -Force)
   Set-ADUser -Identity jdoe -ChangePasswordAtLogon $true
   
   # Notify user of password reset
   ```

2. **Reset Service Account Passwords (if applicable):**
   - If system runs services with domain credentials
   - Reset and update service configurations

3. **Rotate Sensitive Credentials:**
   - Reset any passwords stored on system
   - Rotate API keys, tokens
   - Reset database connection strings

4. **Revoke Active Sessions:**
   ```powershell
   # Microsoft 365 - Revoke user sessions
   Revoke-AzureADUserAllRefreshToken -ObjectId <user_objectid>
   
   # Active Directory - Force logout
   logoff <sessionID> /server:<computername>
   ```

5. **Review Kerberos Tickets:**
   ```powershell
   # List Kerberos tickets
   klist
   
   # Purge all tickets
   klist purge
   ```

### Step 3: Restore Network Access (10 minutes)

**Objective:** Safely return system to network.

**Actions:**

1. **Verify System Clean:**
   - Confirm all eradication steps completed
   - Run final AV scan (must be clean)
   - Verify no C2 communication
   - Check no suspicious processes

2. **EDR Un-isolation:**
   ```bash
   # CrowdStrike - Lift network containment
   falcon-cli uncontain <hostname>
   
   # Carbon Black - Release endpoint
   cb-cli unisolate --sensor-id <sensor_id>
   ```

3. **Remove Firewall Blocks:**
   - Remove temporary firewall rules blocking host IP
   - Document rules removed

4. **Enhanced Monitoring (30 days):**
   ```spl
   # Create alert for recovered host
   index=windows_sysmon ComputerName="DESKTOP-ABC123"
   | search (EventCode=1) OR (EventCode=3) OR (EventCode=13)
   | where Image!="known_good.exe"
   | table _time, EventCode, Image, CommandLine, DestinationIp
   ```

5. **Test System Functionality:**
   - Verify network connectivity
   - Confirm business applications work
   - Test user can log in and access resources
   - Check printer/file share access

### Step 4: User Communication

**User Notification Template:**
```
Subject: Security Incident Resolved - Malware Remediation

Dear [User Name],

Your system ([HOSTNAME]) was affected by a malware infection that has now been fully remediated by the Security Operations Center.

Incident Summary:
- Detection Date: [YYYY-MM-DD HH:MM UTC]
- Malware Type: [Trojan/Ransomware/etc.]
- System Impact: [Brief description]
- Resolution: [Cleaned/Reimaged]

Actions Taken:
✓ Malware removed from your system
✓ Your password has been reset to: [TempPassword]
✓ System scanned and verified clean
✓ Network access restored

Required Actions:
1. Change your temporary password immediately upon login
2. Review your recent account activity for anything unusual
3. Report any suspicious behavior to security@company.com

Prevention Tips:
- Do not open attachments from unknown senders
- Be cautious clicking links in emails
- Keep software updated
- Report suspicious emails to security@company.com

If you have questions or concerns, please contact:
- SOC Email: security@company.com
- SOC Phone: x5555
- Incident #: INC-2026-XXXXX

Thank you for your cooperation,
Security Operations Center
```

## Post-Incident Activities

### Root Cause Analysis (30 minutes)

**Questions to Answer:**

1. **Initial Access:**
   - How did malware enter environment?
   - Phishing email? Drive-by download? Removable media?
   - What was the infection vector?

2. **Why Detection Delayed?**
   - Why didn't AV catch it initially?
   - Were signatures out of date?
   - Is it zero-day malware?

3. **What Vulnerabilities Exploited?**
   - Unpatched software?
   - Missing endpoint protection?
   - User behavior issue?

4. **Could This Be Prevented?**
   - What controls failed?
   - What controls were missing?

### Improvement Actions

1. **Update Security Controls:**
   - Add file hash to EDR blocklist permanently
   - Add C2 domains to firewall/DNS blocklist
   - Update SIEM correlation rules
   - Improve detection signatures

2. **Patch Vulnerabilities:**
   - Deploy missing patches across environment
   - Update vulnerable applications
   - Fix security misconfigurations

3. **User Awareness:**
   - If user-initiated, provide targeted training
   - Send security awareness reminder to team
   - Update phishing training scenarios

4. **Process Improvements:**
   - Document lessons learned
   - Update playbook with new findings
   - Improve detection rules
   - Reduce time-to-contain

## Escalation Criteria

**Escalate to Tier 2/3 if:**
- Ransomware actively encrypting files
- Rootkit or bootkit detected
- Advanced/custom malware with unknown capabilities
- Data exfiltration confirmed (significant data volume)
- Malware cannot be removed using standard procedures
- Multiple systems infected (>10 hosts)
- Critical server or infrastructure infected
- Evidence of targeted attack or APT

**Escalate to Management if:**
- Executive workstation compromised
- Server hosting sensitive data infected
- Potential data breach (PII, PHI, PCI)
- Regulatory notification may be required
- Business operations significantly impacted
- Ransomware ransom demand received

**Escalate to Law Enforcement if:**
- Ransomware ransom demand (FBI Internet Crime Complaint Center)
- Nation-state actor suspected
- Critical infrastructure attack
- Significant financial losses

**Escalate to Incident Response Team if:**
- Forensics investigation required
- Legal hold needed
- Deep malware reverse engineering required

## Documentation Requirements

**Minimum Required Documentation:**

- Alert details and trigger
- Affected system(s) and user(s)
- Malware identification (name, family, hash)
- Timeline of infection and detection
- Process tree and execution chain
- Network IOCs (C2 IPs, domains)
- Persistence mechanisms discovered
- Containment actions taken
- Eradication steps performed
- Verification of clean system
- Recovery method (reimage/clean)
- User notification sent
- Root cause analysis
- Lessons learned

**Incident Ticket Template:**
```
Incident ID: INC-2026-XXXXX
Title: Malware Infection - [Malware Family] - [Hostname]
Severity: [Critical/High/Medium/Low]
Date Opened: 2026-02-10 09:15 UTC
Date Closed: 2026-02-10 14:30 UTC
Analyst: [Your Name]

ALERT DETAILS:
- Alert Source: [EDR/AV/SIEM/User Report]
- Alert Time: [YYYY-MM-DD HH:MM UTC]
- Alert Name: [Detection name]
- Detection Method: [Signature/Behavioral/Heuristic]

AFFECTED SYSTEM:
- Hostname: [DESKTOP-ABC123]
- IP Address: [10.x.x.x]
- Operating System: [Windows 10 Pro 21H2]
- User: [jdoe / John Doe]
- System Role: [Workstation/Server]
- Criticality: [Low/Medium/High/Critical]

MALWARE DETAILS:
- Malware Family: [TrickBot/Emotet/Cobalt Strike/etc.]
- File Name: [suspicious.exe]
- File Path: [C:\Users\jdoe\AppData\Local\Temp\suspicious.exe]
- File Size: [2.5 MB]
- MD5: [abc123...]
- SHA256: [def456...]
- VirusTotal Detection: [45/70]
- First Seen: [2026-02-09 15:30 UTC]

EXECUTION DETAILS:
- Parent Process: [outlook.exe]
- Process Name: [suspicious.exe]
- PID: [1234]
- Command Line: [Full command line]
- User Context: [jdoe]

NETWORK INDICATORS:
- C2 IP: [185[.]220[.]45[.]12]
- C2 Domain: [malicious[.]c2[.]com]
- C2 Port: [443]
- Protocol: [HTTPS]
- Data Transferred: [2.3 MB]

PERSISTENCE MECHANISMS:
- Registry Run Key: [HKCU\...\Run\Malware]
- Scheduled Task: [MaliciousTask]
- Service: [None detected]
- Other: [None detected]

IMPACT ASSESSMENT:
- Credential Theft: [Yes/No/Unknown]
- Data Exfiltration: [Yes/No/Unknown]
- Lateral Movement: [Yes/No/Unknown]
- Additional Infected Systems: [0]
- Business Impact: [Description]

CONTAINMENT ACTIONS:
- [09:20 UTC] Network isolated via EDR
- [09:22 UTC] Malicious process killed (PID 1234)
- [09:25 UTC] C2 IP blocked at firewall
- [09:27 UTC] C2 domain added to DNS blocklist
- [09:30 UTC] File hash blocked in EDR
- [09:35 UTC] User account disabled

ERADICATION ACTIONS:
- [10:00 UTC] Malicious file deleted
- [10:05 UTC] Registry Run key removed
- [10:10 UTC] Scheduled task removed
- [10:15 UTC] Full AV scan completed - Clean
- [10:20 UTC] Secondary scan (Malwarebytes) - Clean
- [10:25 UTC] Verified no reinfection

RECOVERY ACTIONS:
- [11:00 UTC] System reimaged with SOE image
- [12:00 UTC] Applications reinstalled
- [12:30 UTC] All patches applied
- [13:00 UTC] User password reset
- [13:15 UTC] Network isolation lifted
- [13:30 UTC] User notified and system returned

ROOT CAUSE:
- Initial Vector: [Phishing email with malicious attachment]
- User Action: [User opened attachment in email]
- Contributing Factors: [Macro-enabled document, user lacks awareness training]

LESSONS LEARNED:
- Detection worked as designed (EDR caught execution)
- Response time: 5 minutes from alert to isolation
- Improvement: Need better email filtering for macro documents
- Improvement: Schedule security awareness training for user
- Improvement: Consider blocking macros via GPO

IOCS:
File Hashes:
- MD5: abc123...
- SHA256: def456...

Network:
- IP: 185[.]220[.]45[.]12
- Domain: malicious[.]c2[.]com

Registry:
- Key: HKCU\Software\Microsoft\Windows\CurrentVersion\Run\Malware

RECOMMENDATIONS:
1. Deploy macro blocking GPO to prevent future similar infections
2. Update email filter rules to block macro-enabled documents from external senders
3. Schedule mandatory security awareness training for affected user
4. Add all IOCs to threat intelligence feed
5. Monitor for similar malware family (TrickBot) across environment

STATUS: Closed
OUTCOME: Successfully remediated, no data loss, no lateral movement
```

## MITRE ATT&CK Mapping

| Tactic | Technique | Technique ID | Detection Method |
|--------|-----------|--------------|------------------|
| Execution | User Execution: Malicious File | T1204.002 | EDR process monitoring, Sysmon Event 1 |
| Execution | Command and Scripting Interpreter: PowerShell | T1059.001 | Sysmon Event 1, PowerShell logging |
| Execution | Command and Scripting Interpreter: Windows Command Shell | T1059.003 | Sysmon Event 1, command line logging |
| Persistence | Registry Run Keys / Startup Folder | T1547.001 | Sysmon Event 13, registry monitoring |
| Persistence | Scheduled Task/Job | T1053.005 | Windows Event 4698, Sysmon Event 1 |
| Persistence | Create or Modify System Process: Windows Service | T1543.003 | Windows Event 7045, service creation |
| Persistence | Event Triggered Execution: WMI Event Subscription | T1546.003 | Sysmon Event 19-21, WMI monitoring |
| Defense Evasion | Obfuscated Files or Information | T1027 | PowerShell logging, command line analysis |
| Defense Evasion | Process Injection | T1055 | Sysmon Event 8, EDR behavioral detection |
| Credential Access | OS Credential Dumping: LSASS Memory | T1003.001 | Sysmon Event 10, LSASS access monitoring |
| Credential Access | Input Capture: Keylogging | T1056.001 | EDR behavioral detection |
| Discovery | System Information Discovery | T1082 | Sysmon Event 1, suspicious commands |
| Discovery | File and Directory Discovery | T1083 | Sysmon Event 1, file enumeration |
| Discovery | Process Discovery | T1057 | Sysmon Event 1, process enumeration tools |
| Discovery | Network Service Scanning | T1046 | Network logs, port scanning detection |
| Lateral Movement | Remote Services: SMB/Windows Admin Shares | T1021.002 | Windows Event 5140, SMB logs |
| Lateral Movement | Remote Services: Remote Desktop Protocol | T1021.001 | Windows Event 4624 Type 10 |
| Collection | Data from Local System | T1005 | File access logs, Sysmon Event 11 |
| Command and Control | Application Layer Protocol: Web Protocols | T1071.001 | Sysmon Event 3, proxy logs, firewall logs |
| Command and Control | Application Layer Protocol: DNS | T1071.004 | DNS logs, DNS tunneling detection |
| Command and Control | Non-Standard Port | T1571 | Network monitoring, firewall logs |
| Exfiltration | Exfiltration Over C2 Channel | T1041 | Network monitoring, large data transfers |
| Impact | Data Encrypted for Impact (Ransomware) | T1486 | File system monitoring, EDR detection |

## Decision Tree

```
┌─────────────────────────┐
│   Malware Alert         │
│   Received              │
└────────────┬────────────┘
             │
             ▼
┌─────────────────────────┐
│ Step 1: Initial Triage  │
│ Confirm Infection?      │
└────────────┬────────────┘
             │
         ┌───┴───┐
         │ Real? │
         └───┬───┘
          No │ Yes
     ┌───────┘
     │                    
     ▼                    ▼
[False Positive]    ┌──────────────┐
[Document & Close]  │ CRITICAL:    │
                    │ ISOLATE NOW! │
                    └──────┬───────┘
                           │
                           ▼
                  ┌─────────────────────────┐
                  │ Step 2: Identify Host   │
                  │ & User Details          │
                  └────────────┬────────────┘
                               │
                               ▼
                  ┌─────────────────────────┐
                  │ Step 3: Malware         │
                  │ Artifact Analysis       │
                  │ (Hash, File, VT)        │
                  └────────────┬────────────┘
                               │
                               ▼
                  ┌─────────────────────────┐
                  │ Step 4: Process Tree    │
                  │ Analysis                │
                  └────────────┬────────────┘
                               │
                               ▼
                  ┌─────────────────────────┐
                  │ Step 5: Network         │
                  │ Connection Check        │
                  └────────────┬────────────┘
                               │
                        C2 Active?
                          │
                      Yes │ No
                          ▼
                  ┌─────────────────┐
                  │ URGENT: Block   │
                  │ C2 at Firewall  │
                  └─────────┬───────┘
                            │
                            ▼
                  ┌─────────────────────────┐
                  │ Step 6: Persistence     │
                  │ Mechanism Check         │
                  └────────────┬────────────┘
                               │
                      Persistence Found?
                          │
                      Yes │ No
                          ▼    [Lower Risk]
                  [Higher Risk]
                          │
                          ▼
                  ┌─────────────────────────┐
                  │ Step 7: Credential      │
                  │ Access Check            │
                  └────────────┬────────────┘
                               │
                      Creds Stolen?
                          │
                      Yes │ No
                          ▼    [No Cred Reset]
                  [Reset Passwords]
                          │
                          ▼
                  ┌─────────────────────────┐
                  │ Step 8: Lateral         │
                  │ Movement Check          │
                  └────────────┬────────────┘
                               │
                      Spread Detected?
                          │
                  Yes ┌───┴───┐ No
                      │       │
                      ▼       ▼
              [Isolate More]  [Single Host]
                      │       │
                      └───┬───┘
                          │
                          ▼
                  ┌─────────────────────────┐
                  │ Containment Complete    │
                  │ - Host Isolated         │
                  │ - Process Killed        │
                  │ - C2 Blocked            │
                  └────────────┬────────────┘
                               │
                               ▼
                  ┌─────────────────────────┐
                  │ Eradication             │
                  │ - Remove Files          │
                  │ - Remove Persistence    │
                  │ - AV Scan               │
                  │ - Verify Clean          │
                  └────────────┬────────────┘
                               │
                     ┌─────────┴─────────┐
                     │ Recovery Method?  │
                     └─────────┬─────────┘
                               │
                    ┌──────────┴──────────┐
                    │                     │
              Reimage                  Clean
                    │                     │
                    ▼                     ▼
         [Deploy SOE Image]    [Restore from Backup]
         [Patch System]        [System Integrity Check]
                    │                     │
                    └──────────┬──────────┘
                               │
                               ▼
                  ┌─────────────────────────┐
                  │ Recovery Actions        │
                  │ - Reset Credentials     │
                  │ - Restore Network       │
                  │ - Enhanced Monitoring   │
                  │ - User Notification     │
                  └────────────┬────────────┘
                               │
                               ▼
                  ┌─────────────────────────┐
                  │ Documentation &         │
                  │ Lessons Learned         │
                  │ - Root Cause            │
                  │ - Improvements          │
                  │ - Close Ticket          │
                  └─────────────────────────┘
```

## Lessons Learned

**Common Mistakes to Avoid:**
- Delaying isolation while investigating (isolate immediately!)
- Not checking for lateral movement to other systems
- Forgetting to reset credentials after infection
- Removing malware but missing persistence mechanisms
- Bringing system back online before verifying clean
- Insufficient documentation of IOCs
- Not updating detections with new IOCs
- Cleaning instead of reimaging for critical infections

**Best Practices:**
- Isolate first, investigate deeper later
- Always assume credentials compromised
- Document all IOCs for threat intelligence
- Use hash-based detection, not just filenames
- Check for reinfection before restoring network access
- Maintain communication with affected users
- Update security controls with lessons learned
- Practice incident response procedures regularly

**Time-Saving Tips:**
- Use EDR for remote containment/investigation
- Leverage automation for IOC blocking
- Have remediation scripts ready
- Use SOAR platform for orchestration
- Maintain runbooks for common malware families
- Keep contact list for escalations updated

## References

- **NIST SP 800-61 Rev. 2:** Computer Security Incident Handling Guide
- **SANS Incident Handler's Handbook:** https://www.sans.org/reading-room/whitepapers/incident/incident-handlers-handbook-33901
- **MITRE ATT&CK Framework:** https://attack.mitre.org/
- **Malware Archaeology:** https://www.malwarearchaeology.com/
- **Sysmon Configuration:** https://github.com/SwiftOnSecurity/sysmon-config
- **Windows Sysinternals:** https://docs.microsoft.com/en-us/sysinternals/

## Appendix: Common Malware Families

**Ransomware:**
- Ryuk, Conti, LockBit, BlackCat/ALPHV
- Behavior: Encrypt files, delete backups, ransom demand
- Priority: CRITICAL - Isolate immediately

**Info Stealers:**
- RedLine, Vidar, Raccoon, AZORult
- Behavior: Steal credentials, cookies, crypto wallets
- Priority: HIGH - Reset all credentials

**Remote Access Trojans (RATs):**
- Cobalt Strike, Metasploit, NetWire, AsyncRAT
- Behavior: Remote control, command execution
- Priority: HIGH - Check for lateral movement

**Banking Trojans:**
- Emotet, TrickBot, QakBot, Dridex
- Behavior: Steal banking credentials, dropper for other malware
- Priority: HIGH - Often leads to ransomware

**Cryptominers:**
- XMRig, Monero miners
- Behavior: Use CPU/GPU for cryptocurrency mining
- Priority: MEDIUM - Performance impact

---

**Version History:**
- v1.0 (2026-02-10): Initial playbook creation

**Next Review Date:** 2026-05-10
